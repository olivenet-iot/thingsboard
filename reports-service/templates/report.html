<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SignConnect Report — {{ entity_name }}</title>
<style>
  @page {
    size: A4;
    margin: 16mm 14mm 20mm 14mm;
    @bottom-center {
      content: "SignConnect  |  Page " counter(page) " of " counter(pages) "  |  lumosoft.io";
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      font-size: 7pt;
      color: #94a3b8;
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: "Inter", "Segoe UI", system-ui, sans-serif;
    font-size: 9.5pt;
    color: #0f172a;
    line-height: 1.45;
  }

  /* ── Header ─────────────────────────────────────────── */
  .header-accent {
    height: 4px;
    background: #f59e0b;
    margin-bottom: 14px;
  }

  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }

  .header-brand {
    font-size: 10pt;
    font-weight: 700;
    color: #0f172a;
    letter-spacing: 0.5px;
  }

  .header-tag {
    font-size: 8pt;
    font-weight: 600;
    color: #94a3b8;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .header-entity {
    font-size: 20pt;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 2px;
  }

  .header-period {
    font-size: 10pt;
    color: #334155;
    margin-bottom: 10px;
  }

  .divider {
    border: none;
    border-top: 1px solid #e2e8f0;
    margin: 10px 0 16px 0;
  }

  /* ── Section titles ─────────────────────────────────── */
  .section-title {
    font-size: 11pt;
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 10px;
    padding-bottom: 3px;
    border-bottom: 2px solid #f59e0b;
    display: block;
    width: fit-content;
    page-break-after: avoid;
  }

  /* ── KPI cards ──────────────────────────────────────── */
  .kpi-row {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 20px;
  }

  .kpi-card {
    flex: 1;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 5px;
    padding: 10px 8px;
    text-align: center;
  }

  .kpi-value {
    font-size: 18pt;
    font-weight: 700;
    color: #0f172a;
    line-height: 1.2;
  }

  .kpi-value.accent-amber { color: #d97706; }
  .kpi-value.accent-emerald { color: #059669; }
  .kpi-value.accent-red { color: #ef4444; }

  .kpi-label {
    font-size: 7pt;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-top: 3px;
  }

  /* ── Chart sections ─────────────────────────────────── */
  .chart-section {
    margin-bottom: 18px;
  }

  .chart-section img {
    width: 100%;
    height: auto;
  }

  .stats-line {
    font-size: 8pt;
    color: #64748b;
    margin-top: 4px;
  }

  .stats-line strong {
    color: #0f172a;
  }

  /* ── Device overview (table + donut side by side) ──── */
  .device-overview {
    page-break-before: always;
    overflow: hidden;  /* clearfix for floats */
    margin-bottom: 18px;
  }

  .device-table-wrap {
    float: left;
    width: 70%;
  }

  .device-table-wrap table {
    margin-bottom: 0;
  }

  .device-donut-wrap {
    float: right;
    width: 26%;
    text-align: center;
    padding-top: 10px;
  }

  .device-donut-wrap img {
    width: 100%;
    max-width: 200px;
    height: auto;
  }

  /* ── Tables ─────────────────────────────────────────── */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 18px;
    font-size: 8.5pt;
  }

  thead th {
    background: #0f172a;
    color: #ffffff;
    font-weight: 600;
    padding: 6px 8px;
    text-align: left;
    font-size: 7pt;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  thead th.num {
    text-align: right;
  }

  tbody td {
    padding: 5px 8px;
    border-bottom: 1px solid #e2e8f0;
  }

  tbody td.num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  tbody tr:nth-child(even) {
    background: #f8fafc;
  }

  tbody tr {
    page-break-inside: avoid;
  }

  /* ── Status dot ─────────────────────────────────────── */
  .status-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 4px;
    vertical-align: middle;
  }
  .status-dot.online { background: #059669; }
  .status-dot.offline { background: #94a3b8; }

  /* ── Severity badges ────────────────────────────────── */
  .badge {
    display: inline-block;
    padding: 1px 7px;
    border-radius: 8px;
    font-size: 7pt;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .badge-critical {
    background: #fef2f2;
    color: #ef4444;
  }

  .badge-major {
    background: #fffbeb;
    color: #f59e0b;
  }

  .badge-warning {
    background: #f8fafc;
    color: #334155;
  }

  .badge-minor {
    background: #f8fafc;
    color: #94a3b8;
  }

  /* ── No-faults box ──────────────────────────────────── */
  .no-faults-box {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 5px;
    padding: 12px 16px;
    text-align: center;
    color: #166534;
    font-size: 9pt;
    font-weight: 600;
    margin-bottom: 18px;
  }

  /* ── Avoid page breaks inside sections ──────────────── */
  .keep-together {
    page-break-inside: avoid;
  }
</style>
</head>
<body>

<!-- ══════════════ HEADER ══════════════ -->
<div class="header-accent"></div>
<div class="header-row">
  <span class="header-brand">SignConnect</span>
  <span class="header-tag">Operational Report</span>
</div>
<div class="header-entity">{{ entity_name }}</div>
<div class="header-period">{{ period }}</div>
<hr class="divider">

<!-- ══════════════ KPI CARDS ══════════════ -->
{% if "summary" in sections %}
<div class="kpi-row">
  <div class="kpi-card">
    <div class="kpi-value">{{ device_count }}</div>
    <div class="kpi-label">Devices</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-value accent-emerald">{{ online_count }}</div>
    <div class="kpi-label">Online</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-value accent-red">{{ fault_count }}</div>
    <div class="kpi-label">Faults</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-value accent-amber">{{ "%.1f"|format(energy_kwh) }}</div>
    <div class="kpi-label">Energy (kWh)</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-value">{{ "%.1f"|format(co2_kg) }}</div>
    <div class="kpi-label">CO&#x2082; (kg)</div>
  </div>
</div>
{% endif %}

<!-- ══════════════ ENERGY TREND ══════════════ -->
{% if "energy" in sections and charts.energy_trend %}
<div class="chart-section keep-together">
  <div class="section-title">Energy Consumption</div>
  <img src="{{ charts.energy_trend }}" alt="Energy consumption trend">
  <div class="stats-line">
    Total: <strong>{{ "%.1f"|format(energy_kwh) }} kWh</strong>
    &nbsp;&middot;&nbsp;
    {{ interval_label|default("Daily", true)|title }} avg: <strong>{{ "%.1f"|format(daily_avg_kwh) }} kWh</strong>
    &nbsp;&middot;&nbsp;
    Peak: <strong>{{ "%.1f"|format(peak_kwh) }} kWh</strong>
  </div>
</div>
{% endif %}

<!-- ══════════════ CO₂ TREND ══════════════ -->
{% if "co2" in sections and charts.co2_trend %}
<div class="chart-section keep-together">
  <div class="section-title">CO&#x2082; Emissions</div>
  <img src="{{ charts.co2_trend }}" alt="CO2 emissions trend">
  <div class="stats-line">
    Total: <strong>{{ "%.1f"|format(co2_kg) }} kg</strong>
    &nbsp;&middot;&nbsp;
    {{ interval_label|default("Daily", true)|title }} avg: <strong>{{ "%.1f"|format(daily_avg_co2) }} kg</strong>
    &nbsp;&middot;&nbsp;
    Peak: <strong>{{ "%.1f"|format(peak_co2) }} kg</strong>
  </div>
</div>
{% endif %}

<!-- ══════════════ DIM LEVEL ══════════════ -->
{% if charts.dim_trend %}
<div class="chart-section keep-together">
  <div class="section-title">Dim Level</div>
  <img src="{{ charts.dim_trend }}" alt="Dim level trend">
</div>
{% endif %}

<!-- ══════════════ DEVICE OVERVIEW ══════════════ -->
{% if "summary" in sections and devices %}
<div class="device-overview">
  <div class="section-title">Device Overview</div>
  <div class="device-table-wrap">
    <table>
      <thead>
        <tr>
          <th>Device</th>
          {% if entity_type != "site" %}<th>Site</th>{% endif %}
          <th>Status</th>
          <th>Last Active</th>
          <th class="num">Energy (kWh)</th>
          <th class="num">CO&#x2082; (kg)</th>
        </tr>
      </thead>
      <tbody>
        {% for dev in devices %}
        <tr>
          <td>{{ dev.name }}</td>
          {% if entity_type != "site" %}<td>{{ dev.site }}</td>{% endif %}
          <td>
            <span class="status-dot {{ 'online' if dev.status == 'Online' else 'offline' }}"></span>
            {{ dev.status }}
          </td>
          <td>{{ dev.last_active }}</td>
          <td class="num">{{ "%.1f"|format(dev.energy_kwh) }}</td>
          <td class="num">{{ "%.1f"|format(dev.co2_kg) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if charts.status_donut %}
  <div class="device-donut-wrap">
    <img src="{{ charts.status_donut }}" alt="Device status breakdown">
  </div>
  {% endif %}
</div>
{% endif %}

<!-- ══════════════ FAULT LOG ══════════════ -->
{% if "faults" in sections %}
<div class="keep-together">
  <div class="section-title">Fault Log</div>
  {% if faults %}
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Site</th>
        <th>Device</th>
        <th>Alarm Type</th>
        <th>Severity</th>
        <th>Duration</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for f in faults %}
      <tr>
        <td>{{ f.date }}</td>
        <td>{{ f.site }}</td>
        <td>{{ f.device }}</td>
        <td>{{ f.alarm_type }}</td>
        <td>
          {% if f.severity == "CRITICAL" %}
          <span class="badge badge-critical">{{ f.severity }}</span>
          {% elif f.severity == "MAJOR" %}
          <span class="badge badge-major">{{ f.severity }}</span>
          {% elif f.severity == "WARNING" %}
          <span class="badge badge-warning">{{ f.severity }}</span>
          {% else %}
          <span class="badge badge-minor">{{ f.severity }}</span>
          {% endif %}
        </td>
        <td>{{ f.duration }}</td>
        <td>{{ f.status }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="no-faults-box">
    No faults recorded during this period.
  </div>
  {% endif %}
</div>
{% endif %}

</body>
</html>
