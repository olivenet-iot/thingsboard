<div id="dali-scheduler">
  <!-- ===== LOADING OVERLAY ===== -->
  <div id="loading-overlay" class="loading-overlay" style="display:none;">
    <div class="spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- ===== TOAST NOTIFICATION ===== -->
  <div id="toast" class="toast" style="display:none;"></div>

  <!-- ===== HEADER ===== -->
  <div class="header">
    <div class="header-left">
      <svg class="header-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
      <h1 class="header-title">DALI Task Scheduler</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="DALI.showNewTask()">
        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        New Task
      </button>
      <button class="btn btn-secondary" onclick="DALI.queryAllTasks()">
        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
        Query All
      </button>
      <button class="btn btn-secondary" onclick="DALI.showLocationSetup()">
        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
        Location
      </button>
    </div>
  </div>

  <!-- ===== SECTION A: TASK TABLE ===== -->
  <div class="section">
    <div id="task-table-container">
      <table class="task-table" id="task-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Profile ID</th>
            <th>Priority</th>
            <th>Date Range</th>
            <th>Schedule</th>
            <th>Cyclic</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="task-table-body">
        </tbody>
      </table>
      <div id="empty-state" class="empty-state" style="display:none;">
        <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48" style="opacity:0.3"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/></svg>
        <p>No tasks deployed.</p>
        <p class="empty-hint">Click <strong>+ New Task</strong> to create your first schedule.</p>
      </div>
    </div>
  </div>

  <!-- ===== SECTION C: 24-HOUR TIMELINE ===== -->
  <div class="section">
    <div class="section-label">24-Hour Timeline</div>
    <div id="timeline-container" class="timeline-container">
      <svg id="timeline-svg" width="100%" height="120" viewBox="0 0 960 120" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <div id="timeline-empty" class="timeline-empty" style="display:none;">No time slots to display.</div>
  </div>

  <!-- ===== SECTION E: STATUS BAR ===== -->
  <div class="section status-section">
    <div class="status-bar">
      <div class="status-item">
        <span class="status-label">Task Response:</span>
        <span id="task-response-text" class="status-value">--</span>
      </div>
      <div class="status-item">
        <span class="status-label">Query Response:</span>
        <span id="query-response-text" class="status-value">--</span>
      </div>
      <div class="status-item status-refresh">
        <span id="last-refresh-text" class="status-hint">Auto-refresh: 30s</span>
        <button class="btn btn-small" onclick="DALI.refreshStatus()">Refresh</button>
      </div>
    </div>
  </div>

  <!-- ===== SECTION B: TASK FORM (OVERLAY) ===== -->
  <div id="task-form-overlay" class="overlay" style="display:none;">
    <div class="overlay-backdrop" onclick="DALI.hideTaskForm()"></div>
    <div class="form-panel">
      <div class="form-header">
        <h2 id="form-title">New Task</h2>
        <button class="btn-icon" onclick="DALI.hideTaskForm()" title="Close">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
      <div class="form-body">
        <!-- Row 1: Profile + Priority + Channel -->
        <div class="form-row three-col">
          <div class="form-group">
            <label>Profile ID</label>
            <input type="number" id="f-profile-id" min="1" max="255" value="1" class="input">
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select id="f-priority" class="input">
              <option value="1">1 - Highest</option>
              <option value="2">2 - High</option>
              <option value="3" selected>3 - Medium</option>
              <option value="4">4 - Low</option>
              <option value="5">5 - Lowest</option>
            </select>
          </div>
          <div class="form-group">
            <label>Channel</label>
            <input type="number" id="f-channel" min="1" max="64" value="1" class="input">
          </div>
        </div>

        <!-- Row 2: Start Date -->
        <div class="form-row two-col">
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="f-start-date" class="input">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <div class="end-date-group">
              <input type="date" id="f-end-date" class="input" style="flex:1">
              <label class="checkbox-label">
                <input type="checkbox" id="f-end-forever" checked onchange="DALI.toggleEndForever()">
                Forever
              </label>
            </div>
          </div>
        </div>

        <!-- Row 3: Cyclic -->
        <div class="form-row two-col">
          <div class="form-group">
            <label>Cyclic Type</label>
            <select id="f-cyclic-type" class="input" onchange="DALI.onCyclicTypeChange()">
              <option value="5">Custom (select days)</option>
              <option value="2">Odd Days</option>
              <option value="3">Even Days</option>
              <option value="4">Cyclic Interval</option>
            </select>
          </div>
          <div class="form-group" id="cyclic-interval-group" style="display:none;">
            <label>Cyclic Interval (days)</label>
            <input type="number" id="f-cyclic-time" min="1" max="365" value="7" class="input">
          </div>
        </div>

        <!-- Row 4: Off Days (Custom only) -->
        <div id="off-days-group" class="form-group">
          <label>Active Days</label>
          <div class="days-row">
            <label class="day-checkbox"><input type="checkbox" data-day="0" checked><span>Sun</span></label>
            <label class="day-checkbox"><input type="checkbox" data-day="1" checked><span>Mon</span></label>
            <label class="day-checkbox"><input type="checkbox" data-day="2" checked><span>Tue</span></label>
            <label class="day-checkbox"><input type="checkbox" data-day="3" checked><span>Wed</span></label>
            <label class="day-checkbox"><input type="checkbox" data-day="4" checked><span>Thu</span></label>
            <label class="day-checkbox"><input type="checkbox" data-day="5" checked><span>Fri</span></label>
            <label class="day-checkbox"><input type="checkbox" data-day="6" checked><span>Sat</span></label>
          </div>
        </div>

        <!-- Time Slots -->
        <div class="timeslots-header">
          <label>Time Slots</label>
          <button class="btn btn-small btn-primary" onclick="DALI.addTimeSlot()" id="add-slot-btn">+ Add Slot</button>
        </div>
        <div id="timeslots-container"></div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="DALI.hideTaskForm()">Cancel</button>
          <button class="btn btn-primary" onclick="DALI.deployTask()" id="deploy-btn">Deploy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SECTION D: LOCATION SETUP DIALOG ===== -->
  <div id="location-overlay" class="overlay" style="display:none;">
    <div class="overlay-backdrop" onclick="DALI.hideLocationSetup()"></div>
    <div class="modal-panel">
      <div class="form-header">
        <h2>Location Setup</h2>
        <button class="btn-icon" onclick="DALI.hideLocationSetup()" title="Close">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
      <div class="form-body">
        <div class="form-group">
          <label>Presets</label>
          <select id="loc-preset" class="input" onchange="DALI.applyLocationPreset()">
            <option value="">-- Select Preset --</option>
            <option value="35.19,33.36,3.0">Cyprus (Nicosia) - 35.19, 33.36, UTC+3</option>
            <option value="34.68,33.04,3.0">Cyprus (Limassol) - 34.68, 33.04, UTC+3</option>
            <option value="51.51,-0.13,0.0">London - 51.51, -0.13, UTC+0</option>
            <option value="40.71,-74.01,-5.0">New York - 40.71, -74.01, UTC-5</option>
            <option value="48.86,2.35,1.0">Paris - 48.86, 2.35, UTC+1</option>
          </select>
        </div>
        <div class="form-row three-col">
          <div class="form-group">
            <label>Latitude</label>
            <input type="number" id="loc-lat" step="0.01" value="35.19" class="input">
          </div>
          <div class="form-group">
            <label>Longitude</label>
            <input type="number" id="loc-lon" step="0.01" value="33.36" class="input">
          </div>
          <div class="form-group">
            <label>Timezone (UTC offset)</label>
            <input type="number" id="loc-tz" step="0.5" min="-12" max="14" value="3.0" class="input">
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="DALI.hideLocationSetup()">Cancel</button>
          <button class="btn btn-primary" onclick="DALI.sendLocationSetup()">Send to Device</button>
          <button class="btn btn-secondary" onclick="DALI.saveLocationOnly()">Save Only</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== CONFIRM DELETE DIALOG ===== -->
  <div id="confirm-overlay" class="overlay" style="display:none;">
    <div class="overlay-backdrop" onclick="DALI.hideConfirm()"></div>
    <div class="modal-panel modal-small">
      <div class="form-header">
        <h2>Confirm Delete</h2>
      </div>
      <div class="form-body">
        <p id="confirm-message">Are you sure you want to delete this task?</p>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="DALI.hideConfirm()">Cancel</button>
          <button class="btn btn-danger" onclick="DALI.confirmDelete()">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  var DEVICE_ID = '41c198d0-0582-11f1-999c-9b8fab55435e';
  var BASE = '/api/plugins/telemetry/DEVICE/' + DEVICE_ID;
  var tasks = [];
  var locationSetup = null;
  var editingIndex = -1;
  var pendingDeleteIndex = -1;
  var timeSlotCount = 0;
  var statusInterval = null;

  // ===================== UTILITY FUNCTIONS =====================

  function getToken() {
    try {
      var t = localStorage.getItem('jwt_token');
      if (t) {
        return t.replace(/^"|"$/g, '');
      }
    } catch(e) {}
    return null;
  }

  function apiGet(path) {
    return fetch(path, {
      headers: { 'X-Authorization': 'Bearer ' + getToken() }
    }).then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });
  }

  function apiPost(path, body) {
    return fetch(path, {
      method: 'POST',
      headers: {
        'X-Authorization': 'Bearer ' + getToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    }).then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text().then(function(text) {
        return text ? JSON.parse(text) : {};
      });
    });
  }

  function showLoading(msg) {
    var el = document.getElementById('loading-overlay');
    el.querySelector('.loading-text').textContent = msg || 'Loading...';
    el.style.display = 'flex';
  }

  function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
  }

  function showToast(msg, type) {
    var el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast toast-' + (type || 'info');
    el.style.display = 'block';
    setTimeout(function() { el.style.display = 'none'; }, 4000);
  }

  function formatDate(y, m, d) {
    return y + '-' + String(m).padStart(2, '0') + '-' + String(d).padStart(2, '0');
  }

  function padTime(h, m) {
    return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
  }

  function priorityStars(p) {
    var full = 6 - p; // priority 1 => 5 stars, priority 5 => 1 star
    var out = '';
    for (var i = 0; i < 5; i++) {
      out += i < full
        ? '<span class="star star-full">&#9733;</span>'
        : '<span class="star star-empty">&#9734;</span>';
    }
    return out;
  }

  function cyclicLabel(type, interval, mask) {
    switch (type) {
      case 2: return 'Odd Days';
      case 3: return 'Even Days';
      case 4: return 'Every ' + interval + 'd';
      case 5:
        if (mask === 0) return 'Every Day';
        var days = ['Su','Mo','Tu','We','Th','Fr','Sa'];
        var active = [];
        for (var i = 0; i < 7; i++) {
          if (!(mask & (1 << i))) active.push(days[i]);
        }
        return active.join(', ');
      default: return '?';
    }
  }

  function slotSummary(slots) {
    if (!slots || !slots.length) return '--';
    return slots.map(function(s, i) {
      var onStr = s.on_event
        ? (s.on_event.charAt(0).toUpperCase() + s.on_event.slice(1) + (s.on_offset ? (s.on_offset > 0 ? '+' : '') + s.on_offset + 'm' : ''))
        : padTime(s.on_hour || 0, s.on_minute || 0);
      var offStr = s.off_event
        ? (s.off_event.charAt(0).toUpperCase() + s.off_event.slice(1) + (s.off_offset ? (s.off_offset > 0 ? '+' : '') + s.off_offset + 'm' : ''))
        : padTime(s.off_hour || 0, s.off_minute || 0);
      return onStr + ' - ' + offStr + ' @ ' + (s.dim_value != null ? s.dim_value : 100) + '%';
    }).join(' | ');
  }

  // ===================== DATA LOADING =====================

  function loadTasksData() {
    return apiGet(BASE + '/values/attributes/SERVER_SCOPE?keys=tasks_data,location_setup')
      .then(function(data) {
        tasks = [];
        locationSetup = null;
        if (data && data.length) {
          data.forEach(function(attr) {
            if (attr.key === 'tasks_data') {
              try {
                tasks = typeof attr.value === 'string' ? JSON.parse(attr.value) : attr.value;
                if (!Array.isArray(tasks)) tasks = [];
              } catch(e) { tasks = []; }
            }
            if (attr.key === 'location_setup') {
              try {
                locationSetup = typeof attr.value === 'string' ? JSON.parse(attr.value) : attr.value;
              } catch(e) { locationSetup = null; }
            }
          });
        }
      });
  }

  function saveTasksData() {
    return apiPost(BASE + '/SERVER_SCOPE', {
      tasks_data: JSON.stringify(tasks)
    });
  }

  function loadStatus() {
    apiGet(BASE + '/values/attributes/CLIENT_SCOPE?keys=task_response,task_query_response')
      .then(function(data) {
        var tr = '--', qr = '--';
        if (data && data.length) {
          data.forEach(function(attr) {
            if (attr.key === 'task_response') {
              try {
                var val = typeof attr.value === 'string' ? JSON.parse(attr.value) : attr.value;
                tr = formatStatusResponse(val, attr.lastUpdateTs);
              } catch(e) { tr = String(attr.value); }
            }
            if (attr.key === 'task_query_response') {
              try {
                var val2 = typeof attr.value === 'string' ? JSON.parse(attr.value) : attr.value;
                qr = formatQueryResponse(val2, attr.lastUpdateTs);
              } catch(e) { qr = String(attr.value); }
            }
          });
        }
        document.getElementById('task-response-text').innerHTML = tr;
        document.getElementById('query-response-text').innerHTML = qr;
        document.getElementById('last-refresh-text').textContent = 'Updated: ' + new Date().toLocaleTimeString();
      })
      .catch(function() {
        document.getElementById('last-refresh-text').textContent = 'Refresh failed';
      });
  }

  function formatStatusResponse(val, ts) {
    if (!val) return '--';
    var time = ts ? new Date(ts).toLocaleString() : '';
    var status = val.status || val.result || '';
    var profile = val.profile_id != null ? ' profile ' + val.profile_id : '';
    var cssClass = (status === 'PASS' || status === 'OK' || status === 'success') ? 'status-pass' : 'status-fail';
    return '<span class="' + cssClass + '">' + status + '</span>' + profile + (time ? ' <span class="status-time">(' + time + ')</span>' : '');
  }

  function formatQueryResponse(val, ts) {
    if (!val) return '--';
    var time = ts ? new Date(ts).toLocaleString() : '';
    if (typeof val === 'object') {
      var text = JSON.stringify(val).substring(0, 200);
      return text + (time ? ' <span class="status-time">(' + time + ')</span>' : '');
    }
    return String(val) + (time ? ' <span class="status-time">(' + time + ')</span>' : '');
  }

  // ===================== RENDER TABLE =====================

  function renderTable() {
    var tbody = document.getElementById('task-table-body');
    var emptyEl = document.getElementById('empty-state');
    var tableEl = document.getElementById('task-table');

    if (!tasks.length) {
      tbody.innerHTML = '';
      tableEl.style.display = 'none';
      emptyEl.style.display = 'flex';
      return;
    }

    tableEl.style.display = 'table';
    emptyEl.style.display = 'none';

    var html = '';
    tasks.forEach(function(t, idx) {
      var dateRange = formatDate(t.start_year, t.start_month, t.start_day);
      dateRange += t.end_forever ? ' - Forever' : ' - ' + formatDate(t.end_year, t.end_month, t.end_day);

      var statusClass = t._status === 'deployed' ? 'badge-success'
        : t._status === 'pending' ? 'badge-warning'
        : t._status === 'error' ? 'badge-error'
        : 'badge-default';
      var statusText = t._status || 'saved';

      html += '<tr>'
        + '<td>' + (idx + 1) + '</td>'
        + '<td><span class="profile-badge">' + t.profile_id + '</span></td>'
        + '<td>' + priorityStars(t.priority) + '</td>'
        + '<td class="date-cell">' + dateRange + '</td>'
        + '<td class="schedule-cell">' + slotSummary(t.time_slots) + '</td>'
        + '<td>' + cyclicLabel(t.cyclic_type, t.cyclic_time, t.off_days_mask) + '</td>'
        + '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>'
        + '<td class="actions-cell">'
        + '  <button class="btn btn-small btn-action" onclick="DALI.editTask(' + idx + ')" title="Edit">'
        + '    <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>'
        + '  </button>'
        + '  <button class="btn btn-small btn-danger-outline" onclick="DALI.requestDelete(' + idx + ')" title="Delete">'
        + '    <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>'
        + '  </button>'
        + '  <button class="btn btn-small btn-action" onclick="DALI.queryTask(' + idx + ')" title="Query from device">'
        + '    <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/></svg>'
        + '  </button>'
        + '</td>'
        + '</tr>';
    });
    tbody.innerHTML = html;
  }

  // ===================== RENDER TIMELINE =====================

  function renderTimeline() {
    var svg = document.getElementById('timeline-svg');
    var emptyEl = document.getElementById('timeline-empty');

    var allSlots = [];
    tasks.forEach(function(t, ti) {
      if (t.time_slots) {
        t.time_slots.forEach(function(s, si) {
          allSlots.push({ task: ti, slot: si, data: s, profileId: t.profile_id });
        });
      }
    });

    if (!allSlots.length) {
      svg.style.display = 'none';
      emptyEl.style.display = 'block';
      return;
    }

    svg.style.display = 'block';
    emptyEl.style.display = 'none';

    var W = 960, H = 120;
    var margin = { left: 40, right: 20, top: 10, bottom: 30 };
    var plotW = W - margin.left - margin.right;
    var plotH = H - margin.top - margin.bottom;
    var barH = Math.min(20, Math.floor(plotH / (allSlots.length + 1)));

    var parts = [];

    // Calculate actual needed height first
    var neededH = margin.top + 14 + allSlots.length * (barH + 4) + margin.bottom + 10;
    var actualH = Math.max(H, neededH);

    // Background
    parts.push('<rect x="0" y="0" width="' + W + '" height="' + actualH + '" fill="#1e293b" rx="4"/>');

    // Grid lines and labels for hours
    for (var h = 0; h <= 24; h += 2) {
      var x = margin.left + (h / 24) * plotW;
      parts.push('<line x1="' + x + '" y1="' + margin.top + '" x2="' + x + '" y2="' + (actualH - margin.bottom) + '" stroke="#475569" stroke-width="0.5"/>');
      parts.push('<text x="' + x + '" y="' + (actualH - 8) + '" fill="#94a3b8" font-size="10" text-anchor="middle">' + String(h).padStart(2, '0') + ':00</text>');
    }

    // Approximate sunrise/sunset markers (06:30 and 18:00 as defaults)
    var sunriseX = margin.left + (6.5 / 24) * plotW;
    var sunsetX = margin.left + (18 / 24) * plotW;
    parts.push('<line x1="' + sunriseX + '" y1="' + margin.top + '" x2="' + sunriseX + '" y2="' + (actualH - margin.bottom) + '" stroke="#f59e0b" stroke-width="1" stroke-dasharray="4,3"/>');
    parts.push('<text x="' + (sunriseX + 3) + '" y="' + (margin.top + 10) + '" fill="#f59e0b" font-size="9">Sunrise</text>');
    parts.push('<line x1="' + sunsetX + '" y1="' + margin.top + '" x2="' + sunsetX + '" y2="' + (actualH - margin.bottom) + '" stroke="#f97316" stroke-width="1" stroke-dasharray="4,3"/>');
    parts.push('<text x="' + (sunsetX + 3) + '" y="' + (margin.top + 10) + '" fill="#f97316" font-size="9">Sunset</text>');

    // Color palette for tasks
    var colors = ['#f59e0b', '#3b82f6', '#22c55e', '#ef4444', '#a855f7', '#06b6d4', '#ec4899', '#84cc16'];

    allSlots.forEach(function(slot, i) {
      var s = slot.data;
      var onHour, offHour;

      if (s.on_event === 'sunrise') {
        onHour = 6.5 + (s.on_offset || 0) / 60;
      } else if (s.on_event === 'sunset') {
        onHour = 18 + (s.on_offset || 0) / 60;
      } else {
        onHour = (s.on_hour || 0) + (s.on_minute || 0) / 60;
      }

      if (s.off_event === 'sunrise') {
        offHour = 6.5 + (s.off_offset || 0) / 60;
      } else if (s.off_event === 'sunset') {
        offHour = 18 + (s.off_offset || 0) / 60;
      } else {
        offHour = (s.off_hour || 0) + (s.off_minute || 0) / 60;
      }

      var dim = s.dim_value != null ? s.dim_value : 100;
      var opacity = Math.max(0.2, dim / 100);
      var color = colors[slot.task % colors.length];
      var y = margin.top + 14 + i * (barH + 4);

      if (offHour > onHour) {
        // Normal range
        var x1 = margin.left + (onHour / 24) * plotW;
        var w = ((offHour - onHour) / 24) * plotW;
        parts.push('<rect x="' + x1 + '" y="' + y + '" width="' + w + '" height="' + barH + '" fill="' + color + '" opacity="' + opacity + '" rx="3"/>');
        parts.push('<text x="' + (x1 + w / 2) + '" y="' + (y + barH / 2 + 4) + '" fill="#fff" font-size="9" text-anchor="middle" font-weight="bold">' + dim + '%</text>');
      } else if (offHour < onHour) {
        // Wraps midnight: draw two segments
        var x1a = margin.left + (onHour / 24) * plotW;
        var w1 = ((24 - onHour) / 24) * plotW;
        parts.push('<rect x="' + x1a + '" y="' + y + '" width="' + w1 + '" height="' + barH + '" fill="' + color + '" opacity="' + opacity + '" rx="3"/>');

        var w2 = (offHour / 24) * plotW;
        parts.push('<rect x="' + margin.left + '" y="' + y + '" width="' + w2 + '" height="' + barH + '" fill="' + color + '" opacity="' + opacity + '" rx="3"/>');

        parts.push('<text x="' + (x1a + w1 / 2) + '" y="' + (y + barH / 2 + 4) + '" fill="#fff" font-size="9" text-anchor="middle" font-weight="bold">' + dim + '%</text>');
      }

      // Label on left
      parts.push('<text x="' + (margin.left - 5) + '" y="' + (y + barH / 2 + 4) + '" fill="#94a3b8" font-size="9" text-anchor="end">P' + slot.profileId + '</text>');
    });

    svg.innerHTML = parts.join('\n');

    // Adjust SVG height
    svg.setAttribute('height', actualH);
    svg.setAttribute('viewBox', '0 0 ' + W + ' ' + actualH);
  }

  // ===================== TASK FORM =====================

  function createTimeSlotHTML(index, slot) {
    slot = slot || {};
    var onEvent = slot.on_event || '';
    var offEvent = slot.off_event || '';
    var onHour = slot.on_hour != null ? slot.on_hour : 18;
    var onMin = slot.on_minute != null ? slot.on_minute : 0;
    var offHour = slot.off_hour != null ? slot.off_hour : 6;
    var offMin = slot.off_minute != null ? slot.off_minute : 0;
    var onOffset = slot.on_offset || 0;
    var offOffset = slot.off_offset || 0;
    var dim = slot.dim_value != null ? slot.dim_value : 100;

    var onType = onEvent ? onEvent : 'fixed';
    var offType = offEvent ? offEvent : 'fixed';

    var html = '<div class="timeslot-card" id="slot-' + index + '">'
      + '<div class="timeslot-header">'
      + '  <span class="timeslot-label">Slot ' + (index + 1) + '</span>'
      + '  <button class="btn-icon btn-remove" onclick="DALI.removeTimeSlot(' + index + ')" title="Remove slot">'
      + '    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>'
      + '  </button>'
      + '</div>'
      + '<div class="timeslot-body">'
      + '  <div class="slot-row">'
      + '    <div class="slot-group">'
      + '      <label>ON Type</label>'
      + '      <select class="input slot-on-type" data-slot="' + index + '" onchange="DALI.onSlotTypeChange(' + index + ', \'on\')">'
      + '        <option value="fixed"' + (onType === 'fixed' ? ' selected' : '') + '>Fixed Time</option>'
      + '        <option value="sunrise"' + (onType === 'sunrise' ? ' selected' : '') + '>Sunrise</option>'
      + '        <option value="sunset"' + (onType === 'sunset' ? ' selected' : '') + '>Sunset</option>'
      + '      </select>'
      + '    </div>'
      + '    <div class="slot-group slot-on-time-group" data-slot="' + index + '" style="' + (onType !== 'fixed' ? 'display:none' : '') + '">'
      + '      <label>ON Time</label>'
      + '      <input type="time" class="input slot-on-time" data-slot="' + index + '" value="' + padTime(onHour, onMin) + '">'
      + '    </div>'
      + '    <div class="slot-group slot-on-offset-group" data-slot="' + index + '" style="' + (onType === 'fixed' ? 'display:none' : '') + '">'
      + '      <label>ON Offset: <span class="offset-val" id="on-offset-val-' + index + '">' + onOffset + 'm</span></label>'
      + '      <input type="range" class="slider slot-on-offset" data-slot="' + index + '" min="-60" max="60" value="' + onOffset + '" oninput="document.getElementById(\'on-offset-val-' + index + '\').textContent=this.value+\'m\'">'
      + '    </div>'
      + '  </div>'
      + '  <div class="slot-row">'
      + '    <div class="slot-group">'
      + '      <label>OFF Type</label>'
      + '      <select class="input slot-off-type" data-slot="' + index + '" onchange="DALI.onSlotTypeChange(' + index + ', \'off\')">'
      + '        <option value="fixed"' + (offType === 'fixed' ? ' selected' : '') + '>Fixed Time</option>'
      + '        <option value="sunrise"' + (offType === 'sunrise' ? ' selected' : '') + '>Sunrise</option>'
      + '        <option value="sunset"' + (offType === 'sunset' ? ' selected' : '') + '>Sunset</option>'
      + '      </select>'
      + '    </div>'
      + '    <div class="slot-group slot-off-time-group" data-slot="' + index + '" style="' + (offType !== 'fixed' ? 'display:none' : '') + '">'
      + '      <label>OFF Time</label>'
      + '      <input type="time" class="input slot-off-time" data-slot="' + index + '" value="' + padTime(offHour, offMin) + '">'
      + '    </div>'
      + '    <div class="slot-group slot-off-offset-group" data-slot="' + index + '" style="' + (offType === 'fixed' ? 'display:none' : '') + '">'
      + '      <label>OFF Offset: <span class="offset-val" id="off-offset-val-' + index + '">' + offOffset + 'm</span></label>'
      + '      <input type="range" class="slider slot-off-offset" data-slot="' + index + '" min="-60" max="60" value="' + offOffset + '" oninput="document.getElementById(\'off-offset-val-' + index + '\').textContent=this.value+\'m\'">'
      + '    </div>'
      + '  </div>'
      + '  <div class="slot-row">'
      + '    <div class="slot-group slot-dim-group">'
      + '      <label>Brightness: <span class="dim-val" id="dim-val-' + index + '">' + dim + '%</span></label>'
      + '      <input type="range" class="slider slider-dim" data-slot="' + index + '" min="0" max="100" value="' + dim + '" oninput="document.getElementById(\'dim-val-' + index + '\').textContent=this.value+\'%\'">'
      + '    </div>'
      + '  </div>'
      + '</div>'
      + '</div>';
    return html;
  }

  function renderTimeSlots(slots) {
    slots = slots || [{}];
    timeSlotCount = slots.length;
    var container = document.getElementById('timeslots-container');
    var html = '';
    slots.forEach(function(s, i) {
      html += createTimeSlotHTML(i, s);
    });
    container.innerHTML = html;
    updateAddSlotButton();
  }

  function updateAddSlotButton() {
    var btn = document.getElementById('add-slot-btn');
    btn.disabled = timeSlotCount >= 4;
    btn.textContent = timeSlotCount >= 4 ? 'Max 4 Slots' : '+ Add Slot';
  }

  function gatherTimeSlots() {
    var slots = [];
    for (var i = 0; i < timeSlotCount; i++) {
      var card = document.getElementById('slot-' + i);
      if (!card) continue;

      var onType = card.querySelector('.slot-on-type').value;
      var offType = card.querySelector('.slot-off-type').value;

      var slot = {};

      if (onType === 'fixed') {
        var onTimeParts = card.querySelector('.slot-on-time').value.split(':');
        slot.on_hour = parseInt(onTimeParts[0]) || 0;
        slot.on_minute = parseInt(onTimeParts[1]) || 0;
        slot.on_offset = 0;
      } else {
        slot.on_event = onType;
        slot.on_hour = 0;
        slot.on_minute = 0;
        slot.on_offset = parseInt(card.querySelector('.slot-on-offset').value) || 0;
      }

      if (offType === 'fixed') {
        var offTimeParts = card.querySelector('.slot-off-time').value.split(':');
        slot.off_hour = parseInt(offTimeParts[0]) || 0;
        slot.off_minute = parseInt(offTimeParts[1]) || 0;
        slot.off_offset = 0;
      } else {
        slot.off_event = offType;
        slot.off_hour = 0;
        slot.off_minute = 0;
        slot.off_offset = parseInt(card.querySelector('.slot-off-offset').value) || 0;
      }

      slot.dim_value = parseInt(card.querySelector('.slider-dim').value) || 0;
      slots.push(slot);
    }
    return slots;
  }

  function gatherOffDaysMask() {
    var mask = 0;
    var checks = document.querySelectorAll('#off-days-group input[type=checkbox]');
    checks.forEach(function(cb) {
      var day = parseInt(cb.getAttribute('data-day'));
      if (!cb.checked) {
        mask |= (1 << day);
      }
    });
    return mask;
  }

  function setOffDaysFromMask(mask) {
    var checks = document.querySelectorAll('#off-days-group input[type=checkbox]');
    checks.forEach(function(cb) {
      var day = parseInt(cb.getAttribute('data-day'));
      cb.checked = !(mask & (1 << day));
    });
  }

  function buildTaskCommand(opType) {
    var profileId = parseInt(document.getElementById('f-profile-id').value) || 1;
    var startDate = document.getElementById('f-start-date').value;
    var endForever = document.getElementById('f-end-forever').checked;
    var endDate = document.getElementById('f-end-date').value;
    var priority = parseInt(document.getElementById('f-priority').value) || 3;
    var cyclicType = parseInt(document.getElementById('f-cyclic-type').value) || 5;
    var cyclicTime = parseInt(document.getElementById('f-cyclic-time').value) || 0;
    var channel = parseInt(document.getElementById('f-channel').value) || 1;

    if (!startDate) {
      showToast('Start date is required', 'error');
      return null;
    }

    var sp = startDate.split('-');
    var cmd = {
      command: 'send_task',
      operation_type: opType,
      profile_id: profileId,
      start_year: parseInt(sp[0]),
      start_month: parseInt(sp[1]),
      start_day: parseInt(sp[2]),
      priority: priority,
      cyclic_type: cyclicType,
      cyclic_time: cyclicType === 4 ? cyclicTime : 0,
      off_days_mask: cyclicType === 5 ? gatherOffDaysMask() : 0,
      channel_number: channel,
      time_slots: gatherTimeSlots()
    };

    if (endForever) {
      cmd.end_forever = true;
    } else {
      if (!endDate) {
        showToast('End date is required when "Forever" is unchecked', 'error');
        return null;
      }
      var ep = endDate.split('-');
      cmd.end_forever = false;
      cmd.end_year = parseInt(ep[0]);
      cmd.end_month = parseInt(ep[1]);
      cmd.end_day = parseInt(ep[2]);
    }

    if (!cmd.time_slots.length) {
      showToast('At least one time slot is required', 'error');
      return null;
    }

    return cmd;
  }

  function taskFromCommand(cmd) {
    var t = {
      profile_id: cmd.profile_id,
      start_year: cmd.start_year,
      start_month: cmd.start_month,
      start_day: cmd.start_day,
      end_forever: cmd.end_forever,
      priority: cmd.priority,
      cyclic_type: cmd.cyclic_type,
      cyclic_time: cmd.cyclic_time,
      off_days_mask: cmd.off_days_mask,
      channel_number: cmd.channel_number,
      time_slots: cmd.time_slots,
      _status: 'deployed',
      _deployed_at: new Date().toISOString()
    };
    if (!cmd.end_forever) {
      t.end_year = cmd.end_year;
      t.end_month = cmd.end_month;
      t.end_day = cmd.end_day;
    }
    return t;
  }

  // ===================== PUBLIC API (window.DALI) =====================

  window.DALI = {

    init: function() {
      showLoading('Loading tasks...');
      var today = new Date();
      document.getElementById('f-start-date').value = today.toISOString().split('T')[0];

      loadTasksData()
        .then(function() {
          renderTable();
          renderTimeline();
          hideLoading();
        })
        .catch(function(err) {
          hideLoading();
          showToast('Failed to load tasks: ' + err.message, 'error');
        });

      loadStatus();
      statusInterval = setInterval(loadStatus, 30000);
    },

    showNewTask: function() {
      editingIndex = -1;
      document.getElementById('form-title').textContent = 'New Task';
      document.getElementById('deploy-btn').textContent = 'Deploy';

      // Reset form
      document.getElementById('f-profile-id').value = tasks.length ? Math.max.apply(null, tasks.map(function(t) { return t.profile_id; })) + 1 : 1;
      document.getElementById('f-priority').value = '3';
      document.getElementById('f-channel').value = '1';
      document.getElementById('f-start-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('f-end-forever').checked = true;
      document.getElementById('f-end-date').disabled = true;
      document.getElementById('f-cyclic-type').value = '5';
      document.getElementById('f-cyclic-time').value = '7';

      setOffDaysFromMask(0);
      DALI.onCyclicTypeChange();
      renderTimeSlots([{}]);

      document.getElementById('task-form-overlay').style.display = 'flex';
    },

    editTask: function(idx) {
      editingIndex = idx;
      var t = tasks[idx];

      document.getElementById('form-title').textContent = 'Edit Task (Profile ' + t.profile_id + ')';
      document.getElementById('deploy-btn').textContent = 'Update & Deploy';

      document.getElementById('f-profile-id').value = t.profile_id;
      document.getElementById('f-priority').value = t.priority;
      document.getElementById('f-channel').value = t.channel_number || 1;
      document.getElementById('f-start-date').value = formatDate(t.start_year, t.start_month, t.start_day);
      document.getElementById('f-end-forever').checked = !!t.end_forever;

      if (!t.end_forever && t.end_year) {
        document.getElementById('f-end-date').value = formatDate(t.end_year, t.end_month, t.end_day);
        document.getElementById('f-end-date').disabled = false;
      } else {
        document.getElementById('f-end-date').value = '';
        document.getElementById('f-end-date').disabled = true;
      }

      document.getElementById('f-cyclic-type').value = t.cyclic_type || 5;
      document.getElementById('f-cyclic-time').value = t.cyclic_time || 7;
      setOffDaysFromMask(t.off_days_mask || 0);
      DALI.onCyclicTypeChange();
      renderTimeSlots(t.time_slots && t.time_slots.length ? t.time_slots : [{}]);

      document.getElementById('task-form-overlay').style.display = 'flex';
    },

    hideTaskForm: function() {
      document.getElementById('task-form-overlay').style.display = 'none';
    },

    toggleEndForever: function() {
      var checked = document.getElementById('f-end-forever').checked;
      document.getElementById('f-end-date').disabled = checked;
    },

    onCyclicTypeChange: function() {
      var val = document.getElementById('f-cyclic-type').value;
      document.getElementById('cyclic-interval-group').style.display = val === '4' ? '' : 'none';
      document.getElementById('off-days-group').style.display = val === '5' ? '' : 'none';
    },

    onSlotTypeChange: function(index, direction) {
      var card = document.getElementById('slot-' + index);
      if (!card) return;
      var type = card.querySelector('.slot-' + direction + '-type').value;
      var timeGroup = card.querySelector('.slot-' + direction + '-time-group[data-slot="' + index + '"]');
      var offsetGroup = card.querySelector('.slot-' + direction + '-offset-group[data-slot="' + index + '"]');
      if (timeGroup) timeGroup.style.display = type === 'fixed' ? '' : 'none';
      if (offsetGroup) offsetGroup.style.display = type === 'fixed' ? 'none' : '';
    },

    addTimeSlot: function() {
      if (timeSlotCount >= 4) return;
      var container = document.getElementById('timeslots-container');
      container.insertAdjacentHTML('beforeend', createTimeSlotHTML(timeSlotCount, {}));
      timeSlotCount++;
      updateAddSlotButton();
    },

    removeTimeSlot: function(index) {
      // Gather current slots, remove the one at index, re-render
      var currentSlots = gatherTimeSlots();
      currentSlots.splice(index, 1);
      if (currentSlots.length === 0) currentSlots.push({});
      renderTimeSlots(currentSlots);
    },

    deployTask: function() {
      try {
        var opType = editingIndex >= 0 ? 2 : 1; // 2=Update, 1=Deploy
        var cmd = buildTaskCommand(opType);
        if (!cmd) return;

        showLoading('Deploying task to device...');

        // Send command to device
        apiPost(BASE + '/SHARED_SCOPE', { task_command: JSON.stringify(cmd) })
          .then(function() {
            // Save to tasks_data
            var taskObj = taskFromCommand(cmd);

            if (editingIndex >= 0) {
              tasks[editingIndex] = taskObj;
            } else {
              tasks.push(taskObj);
            }

            return saveTasksData();
          })
          .then(function() {
            hideLoading();
            showToast('Task deployed successfully', 'success');
            DALI.hideTaskForm();
            renderTable();
            renderTimeline();
            // Refresh status after a short delay to catch the response
            setTimeout(loadStatus, 3000);
          })
          .catch(function(err) {
            hideLoading();
            console.error('Deploy failed:', err);
            var msg = (err && err.message) ? err.message : String(err);
            showToast('Deploy failed: ' + msg, 'error');
          });
      } catch(e) {
        hideLoading();
        console.error('Deploy error (sync):', e);
        showToast('Deploy error: ' + e.message, 'error');
      }
    },

    requestDelete: function(idx) {
      pendingDeleteIndex = idx;
      var t = tasks[idx];
      document.getElementById('confirm-message').textContent =
        'Delete task profile ' + t.profile_id + ' (Priority ' + t.priority + ')? This will send a delete command to the device.';
      document.getElementById('confirm-overlay').style.display = 'flex';
    },

    hideConfirm: function() {
      document.getElementById('confirm-overlay').style.display = 'none';
      pendingDeleteIndex = -1;
    },

    confirmDelete: function() {
      try {
        var idx = pendingDeleteIndex;
        if (idx < 0 || idx >= tasks.length) return;

        var t = tasks[idx];
        DALI.hideConfirm();
        showLoading('Deleting task...');

        // Build delete command
        var cmd = {
          command: 'send_task',
          operation_type: 3, // Delete
          profile_id: t.profile_id,
          start_year: t.start_year,
          start_month: t.start_month,
          start_day: t.start_day,
          end_forever: true,
          priority: t.priority,
          cyclic_type: t.cyclic_type || 5,
          cyclic_time: t.cyclic_time || 0,
          off_days_mask: t.off_days_mask || 0,
          channel_number: t.channel_number || 1,
          time_slots: t.time_slots || []
        };

        apiPost(BASE + '/SHARED_SCOPE', { task_command: JSON.stringify(cmd) })
          .then(function() {
            tasks.splice(idx, 1);
            return saveTasksData();
          })
          .then(function() {
            hideLoading();
            showToast('Task deleted', 'success');
            renderTable();
            renderTimeline();
            setTimeout(loadStatus, 3000);
          })
          .catch(function(err) {
            hideLoading();
            console.error('Delete failed:', err);
            var msg = (err && err.message) ? err.message : String(err);
            showToast('Delete failed: ' + msg, 'error');
          });
      } catch(e) {
        hideLoading();
        console.error('Delete error (sync):', e);
        showToast('Delete error: ' + e.message, 'error');
      }
    },

    queryTask: function(idx) {
      try {
        showLoading('Querying task from device...');
        var cmd = { command: 'task_request', task_index: idx };
        apiPost(BASE + '/SHARED_SCOPE', { task_command: JSON.stringify(cmd) })
          .then(function() {
            hideLoading();
            showToast('Query sent for task index ' + idx + '. Check response below.', 'info');
            setTimeout(loadStatus, 3000);
          })
          .catch(function(err) {
            hideLoading();
            console.error('Query failed:', err);
            var msg = (err && err.message) ? err.message : String(err);
            showToast('Query failed: ' + msg, 'error');
          });
      } catch(e) {
        hideLoading();
        console.error('Query error (sync):', e);
        showToast('Query error: ' + e.message, 'error');
      }
    },

    queryAllTasks: function() {
      try {
        showLoading('Querying all tasks from device...');

        // Send sequentially with small delay to not overwhelm LoRaWAN
        var chain = Promise.resolve();
        for (var j = 0; j < 20; j++) {
          (function(index) {
            chain = chain.then(function() {
              return apiPost(BASE + '/SHARED_SCOPE', {
                task_command: JSON.stringify({ command: 'task_request', task_index: index })
              }).catch(function() { return null; });
            }).then(function() {
              return new Promise(function(resolve) { setTimeout(resolve, 500); });
            });
          })(j);
        }

        chain.then(function() {
          hideLoading();
          showToast('All 20 task queries sent. Responses will arrive over the next few minutes.', 'info');
          setTimeout(loadStatus, 5000);
        }).catch(function(err) {
          hideLoading();
          console.error('Query all failed:', err);
          showToast('Some queries failed', 'error');
        });
      } catch(e) {
        hideLoading();
        console.error('Query all error (sync):', e);
        showToast('Query all error: ' + e.message, 'error');
      }
    },

    // ===== Location Setup =====
    showLocationSetup: function() {
      if (locationSetup) {
        document.getElementById('loc-lat').value = locationSetup.latitude || 35.19;
        document.getElementById('loc-lon').value = locationSetup.longitude || 33.36;
        document.getElementById('loc-tz').value = locationSetup.timezone != null ? locationSetup.timezone : 3.0;
      }
      document.getElementById('location-overlay').style.display = 'flex';
    },

    hideLocationSetup: function() {
      document.getElementById('location-overlay').style.display = 'none';
    },

    applyLocationPreset: function() {
      var val = document.getElementById('loc-preset').value;
      if (!val) return;
      var parts = val.split(',');
      document.getElementById('loc-lat').value = parts[0];
      document.getElementById('loc-lon').value = parts[1];
      document.getElementById('loc-tz').value = parts[2];
    },

    sendLocationSetup: function() {
      try {
        var lat = parseFloat(document.getElementById('loc-lat').value);
        var lon = parseFloat(document.getElementById('loc-lon').value);
        var tz = parseFloat(document.getElementById('loc-tz').value);

        if (isNaN(lat) || isNaN(lon) || isNaN(tz)) {
          showToast('Invalid location values', 'error');
          return;
        }

        var cmd = {
          command: 'location_setup',
          latitude: lat,
          longitude: lon,
          timezone: tz
        };

        showLoading('Sending location to device...');

        apiPost(BASE + '/SHARED_SCOPE', { task_command: JSON.stringify(cmd) })
          .then(function() {
            // Also save as server attribute for reference
            locationSetup = { latitude: lat, longitude: lon, timezone: tz };
            return apiPost(BASE + '/SERVER_SCOPE', {
              location_setup: JSON.stringify(locationSetup)
            });
          })
          .then(function() {
            hideLoading();
            showToast('Location sent to device and saved', 'success');
            DALI.hideLocationSetup();
          })
          .catch(function(err) {
            hideLoading();
            console.error('Location setup failed:', err);
            var msg = (err && err.message) ? err.message : String(err);
            showToast('Location setup failed: ' + msg, 'error');
          });
      } catch(e) {
        hideLoading();
        console.error('Location setup error (sync):', e);
        showToast('Location setup error: ' + e.message, 'error');
      }
    },

    saveLocationOnly: function() {
      try {
        var lat = parseFloat(document.getElementById('loc-lat').value);
        var lon = parseFloat(document.getElementById('loc-lon').value);
        var tz = parseFloat(document.getElementById('loc-tz').value);

        locationSetup = { latitude: lat, longitude: lon, timezone: tz };

        apiPost(BASE + '/SERVER_SCOPE', {
          location_setup: JSON.stringify(locationSetup)
        })
          .then(function() {
            showToast('Location saved (not sent to device)', 'info');
            DALI.hideLocationSetup();
          })
          .catch(function(err) {
            console.error('Save location failed:', err);
            var msg = (err && err.message) ? err.message : String(err);
            showToast('Save failed: ' + msg, 'error');
          });
      } catch(e) {
        console.error('Save location error (sync):', e);
        showToast('Save error: ' + e.message, 'error');
      }
    },

    refreshStatus: function() {
      loadStatus();
    }
  };

  // ===== Auto-init =====
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { DALI.init(); });
  } else {
    // Small delay to ensure DOM is ready in ThingsBoard widget context
    setTimeout(function() { DALI.init(); }, 100);
  }

})();
</script>
